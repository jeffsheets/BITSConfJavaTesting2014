<!DOCTYPE html>
<!--[if IE 7]>
<html lang="en" data-ng-app="main" id="ng-app" class="no-js ie"></html>
<![endif]-->
<!--[if IE 8]>
<html lang="en" data-ng-app="main" id="ng-app" class="no-js ie"></html>
<![endif]-->
<!--[if IE 9]>
<html lang="en" data-ng-app="main" id="ng-app" class="no-js ie9"></html>
<![endif]-->
<!--if [(gt IE 9)|!(IE)] <!-->
<html ng-app="main" class="no-js">
  <!-- <![endif]-->
  <head>
    <meta charset="utf-8">
    <title>Testing Java Code in 2013</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Testing Java Code in 2013">
    <link href="./assets/css/style.css" rel="stylesheet" type="text/css">
  </head>
  <body>
    <div class="reveal">
      <div class="opi-logo"></div>
      <div class="slides">
        <section data-state="index-slide" class="index-section">
          <h1><i class="icon-coffee">&nbsp; &nbsp; </i><i class="icon-thumbs-up"></i></h1>
          <h2>Testing Java Code in 2013</h2>
          <div>Beyond JUnit w/ Hamcrest, Mockito, Spring, and Spock!</div>
          <div>{by Jeff Sheets}</div>
        </section>
        <section>
          <h1><i class="icon-github"></i></h1>
          <p>These slides are up on GitHub!</p><a href="http://jeffsheets.github.io/JavaTesting2013Slides" target="_blank">jeffsheets/JavaTesting2013Slides</a>
        </section>
        <section>
          <section>
            <h2>About Me</h2>
            <ul>
              <li>Java/Grails/Javascript Consultant for OPI</li>
              <li> <i class="icon-twitter">&nbsp;</i><a href="https://twitter.com/sheetsj" target="_blank">@sheetsj</a></li>
              <li>Website &nbsp;<a href="http://sheetsj.com/" target="_blank">http://sheetsj.com/</a></li>
              <li>jeffsheets@gmail.com</li>
            </ul>
          </section>
        </section>
        <section>
          <h2>Objectives Assuming...</h2>
          <ul>
            <li>Spring MVC + JPA/Hibernate</li>
            <li>Using Maven {<i class="icon-frown">}</i></li>
            <li>Using Eclipse/STS/GGTS or RAD {<i class="icon-frown"> </i><i class="icon-frown">}</i></li>
            <li>We want tools newer than JUnit 3</li>
            <li>Possibly use Groovy for tests (but not prod code)</li>
            <div>&nbsp;</div>
            <li>Please ask questions!</li><span>Everyone in this room is an expert!</span>
          </ul>
        </section>
        <section>
          <section>
            <h2>Why test your code?</h2>
            <ul>
              <li>Developers -> Code</li>
              <li>Senior Developers -> Code and Test</li>
              <li>Chuck Norris -> continuously deploys to prod with 100% test coverage -- in COBOL &nbsp;<i class="icon-thumbs-up"></i></li>
            </ul>
          </section>
          <section>
            <h2>Really why test?</h2>
            <ul>
              <li>Obvious (you wouldn't be in this room otherwise)</li>
              <li>Molds your testable <b>coding style</b></li>
              <li>Faster than redeploy-test-repeat</li>
              <li>Coding with <b>confidence</b></li>
              <li>Continuous Deployment &nbsp;<i class="icon-sun"></i></li>
            </ul>
          </section>
          <section>
            <h3>Keep It Simple</h3>
            <ul>
              <li>Do all of your tests pass?</li>
              <li>Jenkins Server (in the cloud!)</li>
              <li>Test Independence</li>
              <li>Not too brittle</li>
            </ul>
          </section>
        </section>
        <section>
          <h3>Sample App</h3>
          <ul>
            <li>Simple Domain Model for Car Maintenance</li>
            <li><i class="icon-github"> </i><a href="https://github.com/jeffsheets/carmaint" target="_blank">https://github.com/jeffsheets/carmaint</a></li>
            <li>Generated by <a href="https://github.com/kolorobot/spring-mvc-quickstart-archetype" target="_blank">spring-mvc-quickstart-archetype</a></li>
          </ul>
        </section>
        <section>
          <section>
            <h3>Unit vs Integration vs Functional</h3>
            <ul>
              <li>unit: JUnit+Mockito or Spock</li>
              <li>int: Spring Transactional and Wiring</li>
              <li>func: Geb, Selenium, Cloud...</li>
              <li>Others???</li>
              <li>How to separate the types?</li>
            </ul>
          </section>
          <section>
            <h2>Separating Testing types - by Dir</h2>
            <ul>
              <li>src/java/main</li>
              <li>src/java/test</li>
              <li>src/java/integration   ???</li>
              <li>src/groovy/test        ---> for spock</li>
              <li>src/groovy/integration</li>
              <li> <b>Maven </b>makes this very <b>difficult!</b></li>
            </ul>
          </section>
          <section>
            <h2>Separating Testing types - by File</h2>
            <ul>
              <li>MyServiceTest.java</li>
              <li>MyServiceIT.java   //Maven failsafe plugin pattern</li>
              <li>MyServiceSpec.groovy //Spock </li>
              <li>MyServiceSpecIT.groovy //Spock + failsafe</li>
              <li>Failsafe setup in <a href="https://github.com/jeffsheets/carmaint/blob/master/pom.xml" target="_blank">Pom.xml </a></li>
            </ul>
          </section>
        </section>
        <section>
          <h2>Traditional JUnit</h2>
          <div>CarRepositoryIT.java</div>
          <pre><code data-trim contenteditable>
//Setup your Eclipse Favorites for code suggestions
import static org.junit.Assert.assertEquals;

/* ... */

assertEquals(2013, result.getYear().intValue());
assertEquals("JunitMotors", result.getMake().getName());
assertEquals(make.getId(), result.getMake().getId());
assertEquals(car.getDescription(), result.getDescription());
</code>

</pre>
        </section>
        <section>
          <section>
            <h2>Hamcrest</h2>
            <div>CarRepositoryIT.java</div>
            <pre><code data-trim contenteditable>
import static org.hamcrest.Matchers.equalTo;
import static org.hamcrest.Matchers.is;
import static org.junit.Assert.assertThat;

/* ... */

assertThat(result.getYear().intValue(), is(equalTo(2013)));
assertThat(result.getMake().getName(), is("JunitMotors"));
assertThat(result.getMake().getId(), is(make.getId()));
assertThat(result.getDescription(), is(car.getDescription()));

//containsString
//equalToIgnoringCase
</code>
</pre>
          </section>
          <section>
            <h2>Hamcrest Details</h2>
            <ul>
              <li>Readable assertions (actual before expected)</li>
              <li><a href="https://code.google.com/p/hamcrest/wiki/Tutorial" target="_blank">Hamcrest Docs</a>
                <div>&nbsp;</div>
              </li>
              <li>ProviderRepositoryIT.java</li>
            </ul>
            <pre><code data-trim contenteditable>
assertThat(result, not(nullValue()));
assertThat(result, hasSize(original.size() + 1));

//This requires overridden provider.equals method
assertThat(result, hasItem(provider));
</code>
</pre>
          </section>
          <section>
            <h2>Custom Matchers</h2>
            <ul>
              <li>Implement Matcher interface</li><span>matches() and describeTo() methods</span>
              <li>Use static methods for <b>readability</b></li>
              <li>CustomMatchers.java and PropertiesIT.java</li>
            </ul>
            <pre><code data-trim contenteditable>
import static com.sheetsj.test.matchers.CustomMatchers.isStringInjected;

/* ... */

assertThat(anotherProperty, isStringInjected());
</code>

</pre>
          </section>
        </section>
        <section>
          <section>
            <h2>Fest</h2>
            <ul>
              <li>Fluent API for writing assertions (readability)</li>
              <li><a href="https://github.com/alexruiz/fest-assert-2.x/wiki/One-minute-starting-guide" target="_blank">Fest Starting Guide</a>
                <div>&nbsp;</div>
              </li>
              <li>UserServiceTest.java</li>
            </ul>
            <pre><code data-trim contenteditable>
import static org.fest.assertions.Assertions.assertThat;

/* ... */

assertThat(demoUser.getEmail()).isEqualTo(userDetails.getUsername());
assertThat(demoUser.getPassword()).isEqualTo(userDetails.getPassword());
assertThat(hasAuthority(userDetails, demoUser.getRole()));
</code>

</pre>
          </section>
        </section>
        <section>
          <section>
            <h2>Checking Thrown Exceptions</h2>
            <div>JUnit 4 actually provides a BAD way</div>
            <pre><code data-trim contenteditable>
//Don't copy this!
@Test(expected=IndexOutOfBoundsException.class)
public void testIndexOutOfBoundsException() {
    Object a = service.getAllResults().get(2);
    Object b = service.getAllForA(a).get(2);
}
</code></pre>
          </section>
          <section>
            <h2>The Better Way</h2>
            <div>Use ExpectedException @Rule (UserServiceTest.java)</div>
            <pre><code data-trim contenteditable>
@Rule
public ExpectedException thrown = ExpectedException.none();

public void shouldThrowExceptionWhenUserNotFound() {
  thrown.expect(UsernameNotFoundException.class);
  thrown.expectMessage("not found");  //NOTE: something funny here
  
  when(accountRepositoryMock.findByEmail("user@example.com")).thenReturn(null);
  
  userService.loadUserByUsername("user@example.com");
}
</code></pre>
          </section>
          <section>
            <h2>The Custom Way</h2>
            <ul>
              <li>BusinessValidationExceptionMatchers.java</li>
              <li>Custom Hamcrest matchers for sourceField and arguments</li>
            </ul>
            <pre><code data-trim contenteditable>
public static void expect(String message, ExpectedException thrown)
{
  thrown.expect(BusinessValidationException.class);
  thrown.expectMessage(equalTo(message));
}

/** From UserServiceTest.java */
public void shouldThrowBusinessExceptionWhenUsernameTooShort() {
  //Uses custom expect matcher using equalTo() instead of containsString()
  expect("username", "username.too.short", thrown, "ab");
  
  userService.loadUserByUsername("ab");
}
</code>

</pre>
          </section>
        </section>
        <section>
          <section>
            <h2>Mockito Annotations</h2>
            <ul>
              <li>We've all used Mockito? JMock? Others?</li>
              <li>Why? To isolate your
                <u> <b>Unit Tests!</b></u>
              </li>
              <li>Mock method return values</li>
              <li>Verify mock methods were called</li>
              <li> <strong>Spy </strong>to mock method on class-under-test</li>
            </ul>
          </section>
        </section>
        <section>
          <section>
            <h2>References</h2>
          </section>
          <section>
            <h3> <a href="http://momentjs.com/" target="_blank">moment.js</a></h3>
            <p>Arguably the best date formatting library on the planet</p>
            <ul>
              <li>Formatting</li>
              <li>Internationalization</li>
              <li>Calculations</li>
              <li>Fuzzy dates</li>
            </ul>
          </section>
        </section>
        <section>
          <section>
            <h2>Conclusion</h2>
          </section>
          <section>
            <h1><i class="icon-question-sign"></i></h1>
            <h2>Questions</h2>
          </section>
          <section>
            <h3>Java Trends in 2013</h3>
            <ul>
              <li>Works out of the box</li>
              <li>Uses development tools</li>
              <li>Run commands as you would locally</li>
            </ul>
          </section>
        </section>
      </div>
    </div>
    <script src="./assets/js/app.js"></script>
  </body>
</html>